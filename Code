
```python
# generate_kmeans_pdf.py
# Usage: python generate_kmeans_pdf.py
import os, zipfile, io, warnings
warnings.filterwarnings("ignore")

import pandas as pd
import numpy as np
from sklearn.cluster import KMeans
from sklearn.preprocessing import StandardScaler
from sklearn.decomposition import PCA
from sklearn.metrics import silhouette_score
import matplotlib.pyplot as plt
from matplotlib.backends.backend_pdf import PdfPages

zip_path = "/mnt/data/archive (2).zip"   # <-- adjust path if needed
out_pdf = "/mnt/data/kmeans_solution.pdf"

extracted_dir = "/mnt/data/extracted_dataset"
os.makedirs(extracted_dir, exist_ok=True)

found_files = []
with zipfile.ZipFile(zip_path, 'r') as z:
    z.extractall(extracted_dir)
    for name in z.namelist():
        if not name.endswith('/'):
            found_files.append(os.path.join(extracted_dir, name))

data_files = [f for f in found_files if f.lower().endswith(('.csv', '.xls', '.xlsx'))]
if len(data_files)==0:
    data_files = found_files[:1]
if len(data_files)==0:
    raise FileNotFoundError("No data files found inside the zip archive.")

data_file = data_files[0]

def load_table(path):
    if path.lower().endswith('.csv'):
        return pd.read_csv(path)
    elif path.lower().endswith(('.xls', '.xlsx')):
        return pd.read_excel(path)
    else:
        try:
            return pd.read_csv(path)
        except:
            return pd.read_table(path, engine='python', sep=None)

df = load_table(data_file)

numeric_df = df.select_dtypes(include=[np.number]).copy()
if numeric_df.shape[1] == 0:
    for col in df.columns:
        coerced = pd.to_numeric(df[col], errors='coerce')
        if coerced.notna().sum() > 0:
            numeric_df[col] = coerced
numeric_df = numeric_df.dropna(axis=1, how='all')

if numeric_df.shape[1] == 0:
    raise ValueError("No numeric columns available for clustering after preprocessing.")

for col in list(numeric_df.columns):
    if numeric_df[col].nunique() == numeric_df.shape[0] and numeric_df[col].dtype in [np.int64, np.int32]:
        numeric_df.drop(columns=[col], inplace=True, errors='ignore')

if numeric_df.shape[1] == 0:
    numeric_df = df.select_dtypes(include=[np.number]).copy()

scaler = StandardScaler()
X = scaler.fit_transform(numeric_df.fillna(numeric_df.mean()))

max_k = min(10, max(2, X.shape[0]-1))
inertias = []
sil_scores = []
k_range = list(range(1, max_k+1))
models = {}
for k in k_range:
    km = KMeans(n_clusters=k, random_state=42, n_init=10)
    km.fit(X)
    inertias.append(km.inertia_)
    models[k] = km
    if k>=2:
        try:
            sil = silhouette_score(X, km.labels_)
        except:
            sil = np.nan
        sil_scores.append((k, sil))

best_k = None
if len(sil_scores) > 0:
    best_k = max(sil_scores, key=lambda x: (np.nan_to_num(x[1], -1), -x[0]))[0]
else:
    drops = np.diff(inertias)
    if len(drops)>0:
        rel_drop = drops[1:]/(drops[:-1]+1e-9)
        if len(rel_drop)>0:
            best_k = 1 + np.argmax(rel_drop)+1
        else:
            best_k = 2
    else:
        best_k = 2

best_model = models.get(best_k, models[2] if 2 in models else list(models.values())[-1])
labels = best_model.predict(X)
silhouette_final = silhouette_score(X, labels) if X.shape[0] >= 2 and len(np.unique(labels))>1 else np.nan

pca = PCA(n_components=2, random_state=42)
X_pca = pca.fit_transform(X)

with PdfPages(out_pdf) as pdf:
    # Title page
    fig = plt.figure(figsize=(8.27, 11.69))
    plt.axis('off')
    title = "Task 8: Clustering with K-Means - Solution"
    info = f"Dataset file used: {os.path.basename(data_file)}\n\nOriginal shape: {df.shape}\nNumeric features used for clustering: {numeric_df.shape[1]} columns\nRows: {df.shape[0]}\n\nSelected features: {', '.join(numeric_df.columns[:8])}"
    txt = f"{title}\n\n{info}\n\nSelected approach:\n- StandardScaler for feature scaling\n- KMeans for clustering (k=1..{max_k})\n- Silhouette score to pick best k (when possible)\n"
    plt.text(0.02, 0.98, txt, va='top', wrap=True, fontsize=10)
    pdf.savefig(fig, bbox_inches='tight'); plt.close(fig)

    # Data preview
    fig = plt.figure(figsize=(8.27, 11.69))
    plt.axis('off')
    sample = numeric_df.head(8).round(4)
    plt.text(0.02, 0.98, "Preview of the dataset (first 8 rows of numeric columns):\n\n", va='top', fontsize=10)
    table = plt.table(cellText=sample.values, colLabels=sample.columns, loc='center', cellLoc='center')
    table.auto_set_font_size(False); table.set_fontsize(8); table.scale(1, 1.2)
    pdf.savefig(fig, bbox_inches='tight'); plt.close(fig)

    # Elbow
    fig = plt.figure(figsize=(8.27, 11.69))
    plt.plot(k_range, inertias, marker='o')
    plt.title('Elbow Method: Inertia vs Number of Clusters (k)')
    plt.xlabel('k'); plt.ylabel('Inertia'); plt.xticks(k_range); plt.grid(True)
    pdf.savefig(fig, bbox_inches='tight'); plt.close(fig)

    # Silhouette
    if len(sil_scores)>0:
        ks, ss = zip(*sil_scores)
        fig = plt.figure(figsize=(8.27, 11.69))
        plt.plot(ks, ss, marker='o')
        plt.title('Silhouette Score vs Number of Clusters (k)')
        plt.xlabel('k'); plt.ylabel('Silhouette Score'); plt.xticks(ks); plt.grid(True)
        pdf.savefig(fig, bbox_inches='tight'); plt.close(fig)

    # PCA clusters
    fig = plt.figure(figsize=(8.27, 11.69))
    for label in np.unique(labels):
        idx = labels == label
        plt.scatter(X_pca[idx,0], X_pca[idx,1], label=f"Cluster {label}", s=30)
    plt.legend()
    plt.title(f'K-Means clusters (k={best_k}) in PCA 2D projection')
    plt.xlabel('PCA 1'); plt.ylabel('PCA 2')
    pdf.savefig(fig, bbox_inches='tight'); plt.close(fig)

    # Summary page
    cluster_summary = numeric_df.copy()
    cluster_summary['cluster'] = labels
    agg = cluster_summary.groupby('cluster').agg(['count','mean','std']).transpose()
    fig = plt.figure(figsize=(8.27, 11.69))
    plt.axis('off')
    plt.text(0.02, 0.98, f"Clustering summary (k={best_k})\nSilhouette score: {np.round(silhouette_final,4)}\n\nAggregated numeric stats (first columns shown):", va='top', fontsize=10)
    tbl = plt.table(cellText=agg.head(20).values, colLabels=[str(c) for c in agg.columns], rowLabels=[str(r) for r in agg.index], loc='center', cellLoc='center')
    tbl.auto_set_font_size(False); tbl.set_fontsize(6); tbl.scale(1, 1.5)
    pdf.savefig(fig, bbox_inches='tight'); plt.close(fig)
